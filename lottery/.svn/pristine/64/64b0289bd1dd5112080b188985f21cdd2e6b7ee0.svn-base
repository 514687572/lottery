let baseUrl = "https://myeosgame.com";
let websocketUrl = "myeosgame.com";
let userName="";
let publicKey="";
let getHisAwardPage=1;
let modelBollen = "0";  //玩家选择的游戏模式，默认基础模式
let totalLimitBets = 0; //投注限额总数
let userLimitBets = 0; //个人投注限额
let userBlance = 0; //用户投注金额
let userPriKey="";  
let totalCpuWidth=$("#totalCpu").width();
let balance=0;
let betsTime=0
let enterLotteryNum=0;


let englistBig="大";
let englistSmall="小";
let englistOdd="单";
let englistEven="双";
let lang="zh";
let ucerror="投注错误"






//私钥登录
$(".Pri_login").click(function(){
    $("#loginContainer").css("display","block");
    $("#userPriKey").blur(function(){
      userPriKey=$("#userPriKey").val();
    })
    $("#privateLogin").click(function(){
      let reg = new RegExp("^[A-Za-z0-9]{51}$");
      console.log(userPriKey)
      if (reg.test(userPriKey) == true) {
        $.ajax({
          type: "post",
          url: `${baseUrl}/account/loginWidthPriKey.do`,
          data: {
            private_key: userPriKey,
            // userCode: userCode ? userCode : ""
          },
          success: function (date) {
            console.log(date);
            userName = date.userName;
            publicKey = date.pubKey;
            $.ajax({
              type: "get",
              url: `${baseUrl}/account/getAccount.do`,
              data: {
                account: date.userName
              },
              success: function (msg) {
                console.log(msg)
                uid = date.userName;
                $("#userInfo").css("display", "block");
                $("#loginContainer").css("display", "none");
                $(".Pri_login").css("display", "none");
                $(".betsBtn").css("display", "block");
                $("#userCpu").css("width",`${parseFloat((msg.cpu.used / msg.cpu.max))*totalCpuWidth/100}rem`);
                $("#userName").text(`${date.userName}`);
                $("#userBalance").text(`${msg.balance ? msg.balance.replace("EOS","") : "0"}`);
                $("#cpuPercent").text(`${parseFloat((msg.cpu.used / msg.cpu.max)*100).toFixed(2)}%`)
              }
            });
          }
        });
      } else {
        jqalert({
          title:'提示',
          content: "请输入正确的51位私钥"
        })
      }
    })
})

function getUserInfo(){
  console.log(userPriKey)
  $.ajax({
    type: "post",
    url: `${baseUrl}/account/loginWidthPriKey.do`,
    data: {
      private_key: userPriKey,
      // userCode: userCode ? userCode : ""
    },
    success: function (date) {
      console.log(date);
      userName = date.userName;
      publicKey = date.pubKey;
      $.ajax({
        type: "get",
        url: `${baseUrl}/account/getAccount.do`,
        data: {
          account: date.userName
        },
        success: function (msg) {
          console.log(msg)
          uid = date.userName;
          $("#userInfo").css("display", "block");
          $("#loginContainer").css("display", "none");
          $(".Pri_login").css("display", "none");
          $(".betsBtn").css("display", "block");
          $("#userCpu").css("width",`${parseFloat((msg.cpu.used / msg.cpu.max))*totalCpuWidth/100}rem`);
          $("#userName").text(`${date.userName}`);
          $("#userBalance").text(`${msg.balance ? msg.balance.replace("EOS","") : "0"}`);
          $("#cpuPercent").text(`${parseFloat((msg.cpu.used / msg.cpu.max)*100).toFixed(2)}%`)
        }
      });
    }
  });
}


$("#loginClose").click(function(){
  $("#loginContainer").css("display","none");
})


//获取历史开奖记录函数(3条)
function getHisAwardThree(){
  $.ajax({
    type:"get",
    url:`${baseUrl}/lottery/getLotteryHis.do`,
    data:{
      pageNum:1,
      rowNum:3
    },
    success:function(msg){
      console.log(msg)
      let str="";
      for(let i=0;i<msg.hisRecords.length; i++){
      enterLotteryNum=msg.hisRecords[0].recordsId;
      $("#periods").text(`第${enterLotteryNum+1}期`)       
      str+=
      `<div style="height:0.24rem;line-height: 0.24rem;display: flex;justify-content: space-between;">
        <span style="color:#b44141;font-size:0.12rem;">
        ${msg.hisRecords[i].lotteryFive}
        ${msg.hisRecords[i].lotteryFour}
        ${msg.hisRecords[i].lotteryThree}
        ${msg.hisRecords[i].lotteryTwo}
        ${msg.hisRecords[i].lotteryOne}
        </span>
        <span style="color:white;font-size:0.12rem;">${datetimeFormat(msg.hisRecords[i].updateTime)}</span>
      </div>`
      }
      $("#awardContainer").html(str);
    }
  })
}
getHisAwardThree();

//历史开奖(10条)
function getHisAwardTen(){
  let a,b,c,d;
  $.ajax({
    type:"get",
    url:`${baseUrl}/lottery/getLotteryHis.do`,
    data:{
      pageNum:getHisAwardPage,
      rowNum:10
    },
    success:function(msg){
      let str="";
      for(let item of msg.hisRecords){
        if (item.largeNum == 0) {
          a = "resultSmall";
          b = "resultBig";
        } else {
          b = "resultSmall";
          a = "resultBig";
        }
        if (item.lotterySingle == 0) {
          c = "resultSingle";
          d = "resultDouble";
        } else {
          d = "resultSingle";
          c = "resultDouble";
        }
        let hisTime=datetimeDay(item.updateTime);
        let month=hisTime.split(" ")[1].split("/");
        let hour=hisTime.split(" ")[2].split(":");
       str+=
          ` 
          <div style="padding:0 0.1rem;height:0.3rem;line-height: 0.3rem;font-size:0.12rem;color:white;text-align: center;display: flex;justify-content: space-between">
          <div style="width: 0.72rem;">${month[1]}/${month[2]} ${hour[0]}:${hour[1]}</div>
          <div style="width: 0.68rem;">${item.recordsId}</div>
          <div style="width: 0.58rem;color:#ff5c4a">${item.lotteryFive}${item.lotteryFour}${item.lotteryThree}${item.lotteryTwo}${item.lotteryOne}</div>
          <div style="width: 0.70rem;"><span><b class=${b}>${englistBig}</b><b class=${a}>${englistSmall}</b></span><span style="color:#ff5c4a">|</span><span><b class=${d}>${englistOdd}</b><b class=${c}>${englistEven}</b></span></div>
        </div>`
      }
      $("#myHisAwardTab").html(str)
    }
  })
}
getHisAwardTen();


//历史投注记录
function getHisBets(){
  if(userName!=""){
    $.ajax({
      type:"get",
      url:`${baseUrl}/lottery/getUserBetHis.do`,
      data: {
        userName:userName,
        pageNum: getHisAwardPage
      },
      success:function(msg){
         let str="";
         for(let item of msg.userHis){
          let hisTime=datetimeDay(item.updateTime);
          let month=hisTime.split(" ")[1].split("/");
          let hour=hisTime.split(" ")[2].split(":");
           if(item.lotteryBonus){
            str+=`  
            <div class="myBetsRow" style="padding:0 0.1rem;height:0.3rem;line-height: 0.3rem;font-size:0.12rem;color:white;text-align: center;display: flex;justify-content: space-between">
              <div style="width: 0.64rem;">${item.betNum}</div>
              <div style="width: 0.60rem;">
              ${item.largeNum == "1" && item.largeNum != null? englistBig: ""}
              ${item.largeNum == "0" && item.largeNum != null? englistSmall: ""}
              ${item.lotterySingle == "1" && item.lotterySingle != null? englistOdd: ""}
              ${item.lotterySingle == "0" && item.lotterySingle != null? englistEven: ""}
              ${item.lotteryFive ? item.lotteryFive : ""}
              ${item.lotteryFour ? item.lotteryFour : ""}
              ${item.lotteryThree ? item.lotteryThree : ""}
              ${item.lotteryTwo ? item.lotteryTwo : ""}
              ${item.lotteryOne ? item.lotteryOne : ""}
              </div>
              <div style="width: 0.28rem;color:#ff5c4a;">中奖</div>
              <div style="width: 0.60rem;color:#ff5c4a;">+${item.lotteryBonus}</div>
              <div style="width: 0.68rem;">${month[1]}/${month[2]} ${hour[0]}:${hour[1]}</div>
            </div>`
           }else{
            let betJsonStr = `${item.betJson}`;
            if (lang == "en_US") {
              betJsonStr = betJsonStr
                .replace("大", "B")
                .replace("小", "S")
                .replace("单", "O")
                .replace("双", "E");
            }
            str+=`  
            <div class="myBetsRow" style="padding:0 0.1rem;height:0.3rem;line-height: 0.3rem;font-size:0.12rem;color:white;text-align: center;display: flex;justify-content: space-between">
              <div style="width: 0.64rem;">${item.betNum}</div>
              <div  title=${betJsonStr} style="width: 0.60rem;overflow: hidden; text-overflow: ellipsis;">
              ${betJsonStr}
              </div>
              <div style="width: 0.28rem;color:#3083de;">投注</div>
              <div style="width: 0.60rem;color:#3083de;">-${item.noteMoney}</div>
              <div style="width: 0.68rem;">${month[1]}/${month[2]} ${hour[0]}:${hour[1]}</div>
            </div>`
           }
         }
         $("#myHisBetTab").html(str);
      }
    })
  }else{
    jqtoast('请先登录!');
  }
}




//获取奖金池
function getBalance(){
  $.ajax({
    type: "get",
    url: `${baseUrl}/account/getSysInfo.do`,
    success: function (msg) {
      balance = parseFloat(
        msg.balance.replace("EOS", "").replace(" ", "")
        ).toFixed(4);
      totalLimitBets = parseFloat(balance * 0.05).toFixed(4);
      if(totalLimitBets>=10000){
        $("#limitBets").text(`/${parseFloat(totalLimitBets / 1000).toFixed(2)}K`)
      }else{
        $("#limitBets").text(`/${parseFloat(totalLimitBets ).toFixed(2)}`)
      }
      $("#bonus").text(
        `${parseFloat(balance).toFixed(2)}`
        );
        console.log(totalLimitBets,balance)
    }
  });
}
getBalance();




// websocket连接获取数据
// let chars = ["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"];
// let path = baseUrl;
// uid = generateMixed(6);
// let from = uid;
// let fromName = generateMixed(6);
// let tempul = $("#hashPlay"); //整个hash值推送区域li的容器
// function generateMixed(n) {
//   var res = "";
//   for (var i = 0; i < n; i++) {
//     var id = Math.ceil(Math.random() * 35);
//     res += chars[id];
//   }
//   return res;
// }

// let websocket = new WebSocket(`wss://${websocketUrl}/ws?userId=${uid}`);
// websocket.onopen = function (event) {};
// let count = 0;
// let endAwad = false; //判断开奖号码是否出完
// let timeEnter, timeStart;

// //wensocket推送信息到前端
// websocket.onmessage = function (event) {
//   let data = JSON.parse(event.data);
//   let dataObj = JSON.parse(data.text);
//   let startDiv = "hashContainer";

//   //将等到的信息传入前端显示
//   if (data.from == "block") {
//     changedTime = Date.parse(dataObj.header.timestamp.replace("-", "/").replace("T", "z")); //数据推送的最新时间
//     timeEnter = datetimeFormat(changedTime); //最新数据的推送时间
//     timeStart = parseInt(timeEnter.split(":")[2]); //最新数据的推送时间只取秒
//     strHashNum1 = ""; //不包含开奖号码的内容
//     strHashNum2 = ""; //包含开奖号码的内容
//     hashNumbers = dataObj.id; //hash值
//     lastNUmber = hashNumbers[hashNumbers.length - 1]; //最后一位
//     strHashNum1 = `<span>...</span><span class=hashBox>${hashNumbers.slice(40,hashNumbers.length - 1)}</span><span style="color:#626368">${lastNUmber}</span>`;
//     strHashNum2 = `<span>...</span><span class=hashBox>${hashNumbers.slice(40,hashNumbers.length - 1)}</span><span style="color:#ff5c4a">${lastNUmber}</span>`;
//     let stringH = "";
//     stringH = 
//     `<div class=${dataObj.prize_start == true?startDiv="findDiv":startDiv="hashContainer"}>
//       <span style="color:#6a727d;font-size:0.12rem;">${dataObj.block_num}</span>
//       <span style="color:#6a727d;font-size:0.12rem;">${dataObj.prize_num == true ? strHashNum2 : strHashNum1}</span>
//       <span style="color:#6a727d;font-size:0.12rem;">${datetimeFormat(changedTime)}</span>
//     </div>`
//     tempul.prepend(stringH);
//     let li = tempul.children(":last");
//     li.animate({
//       marginTop: "0.24rem"
//     },0, function () {
//       li.remove();
//     });

//     //投注区域时间实时计时
//     s = 60 - timeStart;
//     if (s == 1) {
//       $("#betsUsers").text("0");
//       $("#betsUsers").css({
//         width: "0"
//       });
//       // getBalance();
//     }
//     if (s < 10) {
//       $("#timeLeft").text(`0${s}`);
//     } else {
//       $("#timeLeft").text(s);
//     }
//   }
//   // if(dataObj.prize_num == true){
//   //   let awardStr="";
//   //   awardStr+=`${lastNUmber}`
//   //   $("#awardContainer>div:first").html();
//   //   if(dataObj.prize_start == true){
//   //     $("#awardContainer>div:first").prepend(
//   //       `<div style="height:0.24rem;line-height: 0.24rem;display: flex;justify-content: space-between;">
//   //       <span style="color:#b44141;font-size:0.12rem;">
//   //      ${awardStr}
//   //       </span>
//   //       <span style="color:white;font-size:0.12rem;">${datetimeFormat(changedTime)}</span>
//   //     </div>`
//   //     )
//   //     $("#awardContainer>div:last").remove();
//   //   }
//   // }
//   // 投注直播
//   // 用户投注
//   if (data.from == "bet") {
//     userBlance = dataObj.limit;
//     let betLiveTime = datetimeFormat(dataObj.date.time).split(".");
//     $("#betsUsers").text(`${userBlance}`);
//     $("#betsUsers").css({
//       width: `${parseFloat(userBlance / balance).toFixed(2)}px`
//     });
//     let monthDay = data.date.split(" ")[0].split("-");
//     $("#betsLiveContain").prepend(
//       `<div class="userProfit">
//         <p class="userDetail"><span>${
//           dataObj.userName
//         }</span><span style="color:purple">${parseFloat(dataObj.count).toFixed(
//         4
//       )}<b>EOS</b></span></p>
//         <div>
//         <span>${dataObj.num}</span>-<span>${monthDay[1]}/${monthDay[2]}</span>
//         <span>${betLiveTime[0]}</span>
//         </div>
//       </div>`
//     );
//   }

//   //用户已中奖中奖
//   else if (data.from == "prizeMsg") {
//     let prizeTime = datetimeFormat(dataObj.time.time).split(".");
//     getBlance();
//     if (data.fromName == $("#userName").text()) {
//       $.message({
//         type: "success",
//         message: `+${parseFloat(dataObj.pri).toFixed(4)}EOS`
//       });
//       checkIdentity();
//     }
//     pageNumMybets = 1;
//     getHisBets();
//     let monthDay = data.date.split(" ")[0].split("-");
//     $("#betsLiveContain").prepend(
//       `<div class="userProfit">
//             <div class="userDetail"><span>${
//               data.fromName
//             }</span><div style="color:green"><span>+</span><span style="color:green">${parseFloat(
//         dataObj.pri
//       ).toFixed(4)}EOS</span></div></div>
//             <div>
//             <span>${dataObj.num}</span>-<span>${monthDay[1]}/${
//         monthDay[2]
//       }</span><span>${prizeTime[0]}</span>
//             </div>
//         </div>`
//     );
//   }
// };

// websocket.onerror = function (event) {};
// websocket.onclose = function (event) {};


let carouselAry = [];
// let timer = "";
let isStop = false;
let awardCount=0;
let awardStr="";
function theLotteryList(data) {
    if(!isStop){
        let blockChainNo = data.block_num;
        let blockChainHash = data.id.slice(40,data.id.length - 1);
        let lastNumber=data.id[data.id.length-1]
        let normalHashNum=`<b>${lastNumber}</b>`
        let changeColorHashNum=`<b style="color:#ff5c4a">${lastNumber}</b>`
        let openTime = Date.parse(data.header.timestamp.replace("-", "/").replace("T", "z")); //数据推送的最新时间
        let hashTime=datetimeFormat(openTime);
        let timeEnter = datetimeFormat(openTime); //最新数据的推送时间
        let timeStart = parseInt(timeEnter.split(":")[2]); //最新数据的推送时间只取秒
        //投注区域时间实时计时
        betsTime = 60 - timeStart;
        if (betsTime == 1) {
          $("#betsUsers").text("0");
          $("#betsUsers").css({
            width: "0"
          });
          getBalance();
        }
        if (betsTime < 10) {
          $("#timeLeft").text(`0${betsTime}`);
        } else {
          $("#timeLeft").text(betsTime);
        }
        let carouselObj = {
            "blockChainNo": blockChainNo,
            "lastNumber":data.prize_num==true?changeColorHashNum:normalHashNum,
            "blockChainHash": blockChainHash,
            "theLotteryTime": hashTime,
        };
        if (carouselAry.length <= 10) {
            carouselAry.unshift(carouselObj);
        } else {
            carouselAry.pop();
            carouselAry.unshift(carouselObj);
        }
       
        let carouselContent = "";
        for (let item of carouselAry) {
            carouselContent += `
            <div class="hashContainer">
                <span style="color:#6a727d;font-size:0.12rem;">${item.blockChainNo}</span>
                <span style="color:#6a727d;font-size:0.12rem;">...${item.blockChainHash}${item.lastNumber}</span>
                <span style="color:#6a727d;font-size:0.12rem;">${item.theLotteryTime}</span>
            </div>
                `
        }
        lastNumbClass="normalLastNum";
        $("#hashPlay").html(carouselContent);
        if(data.prize_num==true){
          awardStr+=`${lastNumber}`;
          awardCount++;
        };
        if(awardCount==5){
          $("#awardContainer").prepend(
            `<div style="height:0.24rem;line-height: 0.24rem;display: flex;justify-content: space-between;">
         <span style="color:#b44141;font-size:0.12rem;">
        ${awardStr[0]}
        ${awardStr[1]}
        ${awardStr[2]}
        ${awardStr[3]}
        ${awardStr[4]}
         </span>
         <span style="color:white;font-size:0.12rem;">${hashTime}</span>
       </div>`)
       $("#awardContainer>div:last").remove();
       awardCount=0;
       awardStr="";
        }
        $("#hashPlay>div:nth-of-type(1)").animate({marginTop: "0.24rem"});
    }
}

$("#hashPlay").on("mouseenter",".hashContainer",function (){
  $(".hashContainer").css("border","none");
  $(this).css({
      "cursor": "pointer",
      "border":"1px solid #3097ff"
  })
  isStop = true;
});
$("#hashPlay").on("mouseleave",".hashContainer",function (){
  isStop = false;
});
$("#hashPlay").on("click",".hashContainer",function(){
  console.log(111);
})


// websocket连接获取数据
let chars = ["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"];
let path = baseUrl;
uid = generateMixed(6);
let from = uid;
let fromName = generateMixed(6);
let tempul = $("#hashPlay"); //整个hash值推送区域li的容器
function generateMixed(n) {
  var res = "";
  for (var i = 0; i < n; i++) {
    var id = Math.ceil(Math.random() * 35);
    res += chars[id];
  }
  return res;
}

let websocket = new WebSocket(`wss://${websocketUrl}/ws?userId=${uid}`);
websocket.onopen = function (event) {};
let count = 0;
let endAwad = false; //判断开奖号码是否出完
let timeEnter, timeStart;

//wensocket推送信息到前端
websocket.onmessage = function (event) {
  let data = JSON.parse(event.data);
  let dataObj = JSON.parse(data.text);
  //将等到的信息传入前端显示
  if (data.from == "block") {
    theLotteryList(dataObj);
  };

  if (data.from == "bet") {
    userBlance = dataObj.limit;
    let betLiveTime = datetimeFormat(dataObj.date.time).split(".");
    $("#betsUsers").text(`${userBlance}`);
    $("#betsUsers").css({
      width: `${parseFloat(userBlance / balance).toFixed(2)}px`
    });
    let monthDay = data.date.split(" ")[0].split("-");
    $("#betLiveContainer").prepend(`
      <div style="height:0.24rem;line-height: 0.24rem;display: flex;justify-content: space-between;">
      <span style="color:#6a727d;font-size:0.12rem;">${dataObj.userName}</span>
      <span style="color:purple;font-size:0.12rem;">${parseFloat(dataObj.count).toFixed(4)}</span>
      <span style="color:#6a727d;font-size:0.12rem;">${betLiveTime[0]}</span>
   </div>`
    );
  }
  //用户已中奖中奖
  if (data.from == "prizeMsg") {
    let prizeTime = datetimeFormat(dataObj.time.time).split(".");
    getBalance();
    if (data.fromName == $("#userName").text()) {
      console.log(dataObj);
      jqtoast(`+${parseFloat(dataObj.pri).toFixed(4)}`)
      getUserInfo();
    }
    pageNumMybets = 1;
    getHisBets();
    let monthDay = data.date.split(" ")[0].split("-");
    $("#betLiveContainer").prepend(`
    <div style="height:0.24rem;line-height: 0.24rem;display: flex;justify-content: space-between;">
        <span style="color:#6a727d;font-size:0.12rem;">${data.fromName}</span>
        <span style="color:green;font-size:0.12rem;">+${parseFloat(dataObj.pri).toFixed(4)}</span>
        <span style="color:#6a727d;font-size:0.12rem;">${prizeTime[0]}</span>
    </div>`
  );
  }
}
websocket.onerror = function (event) {};
websocket.onclose = function (event) {};